{
  "kind": "spec_vs_diff_report",
  "version": "1.0",
  "generatedAt": "2026-02-15T22:15:24.334Z",
  "summary": "Diff adds an IndexedDB-backed offline cache and an offline operation queue with UI controls (status indicator, sync now, pending changes dialog). However, the offline cache restoration appears to depend on the actor being available, and the individual case cache store keying may allow cross-principal overwrites, risking mixed caches between users.",
  "missing_requirements": [
    {
      "id": "REQ-3",
      "requirement": "Restore cached case list and case details on app start/offline reload (even when the canister/actor is unavailable).",
      "reason": "In useListCases/useGetCase, the queryFn returns early when !actor or !principal, so when offline and the actor is unavailable the code may never attempt to read from IndexedDB cache, preventing offline-after-reload behavior.",
      "evidence": [
        "frontend/src/hooks/useQueries.ts"
      ]
    },
    {
      "id": "REQ-3",
      "requirement": "Cached data must be stored per authenticated principal and must not mix between different logged-in users on the same browser.",
      "reason": "The IndexedDB store for individual case details uses keyPath 'caseId' (not a composite key including principal). Although getCaseCache checks principal before returning, saving a case with the same caseId under a different principal could overwrite the previous user's cached record, effectively mixing/overwriting caches across principals.",
      "evidence": [
        "frontend/src/utils/offlineDb.ts"
      ]
    },
    {
      "id": "REQ-4",
      "requirement": "When connectivity returns, automatically replay queued operations to the canister and reconcile the UI (refresh React Query cache).",
      "reason": "The diff shows loading pending ops on mount (OfflineSyncListener -> loadPendingOps), and a syncOperation implementation, but the provided/truncated excerpts do not show a listener that triggers syncAll automatically on transition back online nor explicit post-sync React Query refresh behavior.",
      "evidence": [
        "frontend/src/components/offline/OfflineSyncListener.tsx",
        "frontend/src/hooks/useOfflineSync.ts (truncated)"
      ]
    }
  ],
  "hallucinated_features": [
    {
      "description": "Enhancements to demographics parsing and sex enum handling (e.g., Male Neutered/Female Spayed detection) and related Quick Add/OCR support.",
      "reason": "Not requested by the offline-mode/cache/deferred-sync BuildRequest; appears to be unrelated feature work.",
      "evidence": [
        "frontend-file-summaries.txt (mentions frontend/src/utils/demographicsParser.ts, frontend/src/utils/ocrText.ts, frontend/src/components/cases/QuickAddDemographics.tsx, frontend/src/utils/surgeryCaseCsvImport.ts)"
      ]
    },
    {
      "description": "CSV import/export parsing enhancements beyond offline sync scope.",
      "reason": "Not requested as part of offline cache/sync requirements.",
      "evidence": [
        "frontend-file-summaries.txt (mentions frontend/src/utils/surgeryCaseCsvImport.ts)"
      ]
    }
  ],
  "confidence": 0.62,
  "changed_files": [
    "frontend-file-summaries.txt",
    "frontend/src/components/auth/LoginButton.tsx",
    "frontend/src/components/cases/ToDoSection.tsx",
    "frontend/src/components/layout/AppLayout.tsx",
    "frontend/src/components/layout/TopNav.tsx",
    "frontend/src/components/offline/OfflineStatusIndicator.tsx",
    "frontend/src/components/offline/OfflineSyncListener.tsx",
    "frontend/src/components/offline/PendingChangesDialog.tsx",
    "frontend/src/hooks/useOfflineStatus.ts",
    "frontend/src/hooks/useOfflineSync.ts",
    "frontend/src/hooks/useQueries.ts",
    "frontend/src/pages/CaseDetailPage.tsx",
    "frontend/src/pages/CaseListPage.tsx",
    "frontend/src/pages/NewCasePage.tsx",
    "frontend/src/types/offlineOps.ts",
    "frontend/src/utils/offlineDb.ts",
    "frontend/src/utils/offlineQueue.ts",
    "project_state.json"
  ]
}